# Vortex 워크플로우 가이드

## 1. 전체 동작 흐름 개요

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Vortex 전체 워크플로우                               │
└─────────────────────────────────────────────────────────────────────────────┘

  [사용자]                    [Vortex App]                    [KakaoT Driver]
     │                            │                                │
     │  1. 앱 실행                │                                │
     │─────────────────────────▶ │                                │
     │                            │                                │
     │  2. 플로팅 UI 시작         │                                │
     │─────────────────────────▶ │                                │
     │                            │                                │
     │  3. ▶ 버튼 클릭           │                                │
     │─────────────────────────▶ │                                │
     │                            │                                │
     │                            │  4. AccessibilityService 감시  │
     │                            │◀───────────────────────────────│
     │                            │                                │
     │                            │  5. 콜 리스트 화면 감지         │
     │                            │◀───────────────────────────────│
     │                            │                                │
     │                            │  6. 콜 리스트 파싱 & 필터링     │
     │                            │  (금액, 키워드, 시간대 확인)    │
     │                            │                                │
     │                            │  7. 조건 충족 콜 아이템 클릭    │
     │                            │───────────────────────────────▶│
     │                            │                                │
     │                            │  8. 콜 상세 화면 감지          │
     │                            │◀───────────────────────────────│
     │                            │                                │
     │                            │  9. btn_call_accept 클릭       │
     │                            │───────────────────────────────▶│
     │                            │                                │
     │                            │ 10. 확인 다이얼로그 감지        │
     │                            │◀───────────────────────────────│
     │                            │                                │
     │                            │ 11. btn_positive 클릭          │
     │                            │───────────────────────────────▶│
     │                            │                                │
     │ 12. 수락 완료 알림         │                                │
     │◀─────────────────────────│                                │
     │                            │                                │
```

---

## 2. 상세 프로세스 플로우

### Phase 1: 앱 초기화

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Phase 1: 앱 초기화                                 │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────┐
  │   앱 시작        │
  └────────┬─────────┘
           │
           ▼
  ┌──────────────────┐     ┌──────────────────────────────────────────────┐
   │ VortexApplication│────▶│ Hilt DI 초기화                               │
  │ @HiltAndroidApp  │     │ - ICallEngine (CallAcceptEngineImpl)        │
  └────────┬─────────┘     │ - ILogger (RemoteLoggerAdapter)             │
           │               │ - StateLoggingObserver (자동 관찰 시작)      │
           │               │ - SettingsManager                           │
           │               └──────────────────────────────────────────────┘
           ▼
  ┌──────────────────┐
  │   MainActivity   │
  │ @AndroidEntryPoint│
  └────────┬─────────┘
           │
           ▼
  ┌──────────────────┐     ┌──────────────────────────────────────────────┐
  │  HomeFragment    │────▶│ CallAcceptViewModel 주입                     │
  │                  │     │ - engine.currentState → LiveData 변환        │
  └──────────────────┘     └──────────────────────────────────────────────┘
```

### Phase 2: 서비스 시작

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Phase 2: 서비스 시작                                │
└─────────────────────────────────────────────────────────────────────────────┘

  [사용자: 플로팅 UI 시작 버튼 클릭]
           │
           ▼
  ┌──────────────────┐
  │ HomeFragment     │
  │ startFloating    │
  │ Service()        │
  └────────┬─────────┘
           │
           │ startService(Intent)
           ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                        FloatingStateService                               │
  │                         @AndroidEntryPoint                                │
  ├──────────────────────────────────────────────────────────────────────────┤
  │  1. Foreground Notification 생성                                         │
  │  2. WindowManager로 플로팅 뷰 추가                                        │
  │  3. 버튼 리스너 설정                                                      │
  │     - ▶ 버튼: engine.start()                                             │
  │     - ⏸ 버튼: engine.stop()                                              │
  │     - ✕ 버튼: stopSelf()                                                 │
  └──────────────────────────────────────────────────────────────────────────┘
           │
           │ [사용자: ▶ 버튼 클릭]
           ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                        CallAcceptEngineImpl                               │
  │                           start() 호출                                    │
  ├──────────────────────────────────────────────────────────────────────────┤
  │  1. _isRunning.value = true                                              │
  │  2. changeState(WAITING_FOR_CALL, "엔진 시작됨")                          │
  │  3. 타임아웃 타이머 시작 (10초)                                           │
  └──────────────────────────────────────────────────────────────────────────┘
           │
           │ StateFlow 변경
           ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                       StateLoggingObserver                                │
  │                         (자동 감지)                                       │
  ├──────────────────────────────────────────────────────────────────────────┤
  │  - logger.logStateChange(IDLE → WAITING_FOR_CALL)                        │
  │  - logger.logAppStart()                                                  │
  └──────────────────────────────────────────────────────────────────────────┘
```

### Phase 3: 콜 감지 및 처리 (3단계 프로세스)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Phase 3: 콜 감지 및 처리 (3단계)                       │
└─────────────────────────────────────────────────────────────────────────────┘

  [KakaoT Driver: 콜 리스트 화면 표시]
           │
           │ AccessibilityEvent 발생
           │ (TYPE_WINDOW_CONTENT_CHANGED)
           ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                   CallAcceptAccessibilityService                          │
  │                         @AndroidEntryPoint                                │
  ├──────────────────────────────────────────────────────────────────────────┤
  │  onAccessibilityEvent(event) {                                           │
  │      if (event.eventType == TYPE_WINDOW_CONTENT_CHANGED ||               │
  │          event.eventType == TYPE_WINDOW_STATE_CHANGED) {                 │
  │          rootInActiveWindow?.let { node ->                               │
  │              engine.processNode(node)  ◀─── ICallEngine 주입             │
  │          }                                                               │
  │      }                                                                   │
  │  }                                                                       │
  └────────────────────────────────┬─────────────────────────────────────────┘
                                   │
                                   ▼
  ┌──────────────────────────────────────────────────────────────────────────┐
  │                        CallAcceptEngineImpl                               │
  │                          processNode()                                    │
  ├──────────────────────────────────────────────────────────────────────────┤
  │  fun processNode(node: AccessibilityNodeInfo) {                          │
  │      if (!_isRunning.value) return                                       │
  │                                                                          │
  │      // 현재 상태에 맞는 핸들러 조회                                       │
  │      val handler = handlerMap[_currentState.value] ?: return             │
  │                                                                          │
  │      // 핸들러 실행                                                       │
  │      when (val result = handler.handle(node, stateContext)) {            │
  │          is Transition → changeState(result.nextState, result.reason)    │
  │          is Error → changeState(result.errorState, result.reason)        │
  │          NoChange → { /* 대기 */ }                                       │
  │      }                                                                   │
  │  }                                                                       │
  └────────────────────────────────┬─────────────────────────────────────────┘
                                   │
       ┌───────────────────────────┼───────────────────────────┐
       │                           │                           │
       ▼                           ▼                           ▼
  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────────────┐
  │ CallListHandler │     │DetectedCallHandler│   │ WaitingForConfirmHandler│
  │ (WAITING_FOR_   │     │ (DETECTED_CALL)  │     │ (WAITING_FOR_CONFIRM)   │
  │     CALL)       │     │                  │     │                         │
  ├─────────────────┤     ├─────────────────┤     ├─────────────────────────┤
  │ 1. RecyclerView │     │ 1. btn_call_    │     │ 1. btn_positive 검색    │
  │    파싱         │     │    accept 검색  │     │ 2. 버튼 클릭 시도        │
  │ 2. 필터 조건    │     │ 2. 버튼 클릭    │     │ 3. 결과 반환             │
  │    확인         │     │    시도         │     └─────────────────────────┘
  │ 3. 조건 충족    │     │ 3. 결과 반환    │
  │    콜 클릭      │     └─────────────────┘
  │ 4. 결과 반환    │
  └─────────────────┘
```

### 3단계 클릭 흐름 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           3단계 클릭 흐름 상세                               │
└─────────────────────────────────────────────────────────────────────────────┘

  Step 1: 콜 리스트 선택 (CallListHandler)
  ─────────────────────────────────────────
  ┌─────────────────────────────┐
  │    콜 리스트 화면            │
  │  ┌─────────────────────┐   │
  │  │ 예약 콜 1  15,000원  │←─┼── 조건 충족 시 클릭
  │  ├─────────────────────┤   │
  │  │ 예약 콜 2  12,000원  │   │
  │  ├─────────────────────┤   │
  │  │ 예약 콜 3  18,000원  │   │
  │  └─────────────────────┘   │
  └─────────────────────────────┘
           │
           │ 조건: 금액 ≥ minAmount
           │      또는 키워드 포함 & 금액 ≥ keywordMinAmount
           │      또는 시간대 범위 내
           ▼
  Step 2: 콜 수락 버튼 (DetectedCallHandler)
  ─────────────────────────────────────────
  ┌─────────────────────────────┐
  │    콜 상세 화면              │
  │                             │
  │  출발지: 강남역              │
  │  목적지: 잠실역              │
  │  금액: 15,000원              │
  │                             │
  │  ┌─────────────────────┐   │
  │  │    콜 수락           │←─┼── btn_call_accept 클릭
  │  └─────────────────────┘   │
  └─────────────────────────────┘
           │
           ▼
  Step 3: 확인 버튼 (WaitingForConfirmHandler)
  ─────────────────────────────────────────
  ┌─────────────────────────────┐
  │    확인 다이얼로그           │
  │                             │
  │  "콜을 수락하시겠습니까?"    │
  │                             │
  │  ┌─────────┐ ┌─────────┐   │
  │  │  취소   │ │ 수락하기 │←─┼── btn_positive 클릭
  │  └─────────┘ └─────────┘   │
  └─────────────────────────────┘
           │
           ▼
  ┌─────────────────────────────┐
  │      수락 완료!              │
  │      CALL_ACCEPTED          │
  └─────────────────────────────┘
```

### Phase 4: 버튼 클릭 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Phase 4: 버튼 클릭 상세                              │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────────────────────────────────────────────────────────┐
  │                       WaitingForCallHandler.handle()                      │
  └────────────────────────────────┬─────────────────────────────────────────┘
                                   │
                                   ▼
                    ┌──────────────────────────────┐
                    │ context.findNode(            │
                    │   node,                      │
                    │   "com.kakao.taxi.driver:    │
                    │    id/btn_call_accept"       │
                    │ )                            │
                    └──────────────┬───────────────┘
                                   │
              ┌────────────────────┼────────────────────┐
              │                    │                    │
              ▼                    ▼                    ▼
        ┌──────────┐        ┌──────────┐        ┌──────────┐
        │  null    │        │ 버튼 있음 │        │ 버튼 있음 │
        │ (없음)   │        │ 클릭 불가 │        │ 클릭 가능 │
        └────┬─────┘        └────┬─────┘        └────┬─────┘
             │                   │                   │
             ▼                   ▼                   ▼
        ┌──────────┐        ┌──────────┐        ┌──────────────────┐
        │ NoChange │        │ NoChange │        │ performAction    │
        │ (재시도) │        │ (재시도) │        │ (ACTION_CLICK)   │
        └──────────┘        └──────────┘        └────────┬─────────┘
                                                         │
                                      ┌──────────────────┼──────────────────┐
                                      │                  │                  │
                                      ▼                  ▼                  │
                                ┌──────────┐       ┌──────────┐            │
                                │ 클릭 성공 │       │ 클릭 실패 │            │
                                └────┬─────┘       └────┬─────┘            │
                                     │                  │                  │
                                     ▼                  ▼                  │
                            ┌─────────────────┐  ┌─────────────────┐       │
                            │ Transition      │  │ Error           │       │
                            │ → WAITING_FOR_  │  │ → ERROR_UNKNOWN │       │
                            │   CONFIRM       │  │                 │       │
                            └─────────────────┘  └─────────────────┘       │
                                     │                                     │
                                     ▼                                     │
                            ┌─────────────────┐                            │
                            │ 다음 핸들러:     │                            │
                            │ WaitingForConfirm│◀───────────────────────────┘
                            │ Handler 실행    │
                            └─────────────────┘
```

---

## 3. 상태 전이 다이어그램 (3단계 플로우)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       상태 전이 다이어그램 (3단계)                           │
└─────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────┐
                                    │  IDLE   │
                                    │ (대기)  │
                                    └────┬────┘
                                         │
                                         │ engine.start()
                                         ▼
                              ┌──────────────────────┐
          ┌───────────────────│  WAITING_FOR_CALL    │◀──────────────────┐
          │                   │   (콜 리스트 대기)    │                   │
          │                   │   [CallListHandler]  │                   │
          │                   └──────────┬───────────┘                   │
          │                              │                               │
          │                              │ 조건 충족 콜 아이템             │
          │                              │ 클릭 성공                      │
          │                              ▼                               │
          │                   ┌──────────────────────┐                   │
          │                   │    DETECTED_CALL     │                   │
          │                   │   (콜 상세 화면)      │                   │
          │                   │ [DetectedCallHandler]│                   │
          │                   └──────────┬───────────┘                   │
          │                              │                               │
          │                              │ btn_call_accept               │
          │                              │ 클릭 성공                      │
          │                              ▼                               │
          │                   ┌──────────────────────┐                   │
          │                   │ WAITING_FOR_CONFIRM  │                   │
          │                   │ (확인 다이얼로그 대기)│                   │
          │                   │[WaitingForConfirmHandler]                │
          │                   └──────────┬───────────┘                   │
          │                              │                               │
          │               ┌──────────────┼──────────────┐               │
          │               │              │              │               │
          │               ▼              ▼              ▼               │
          │         ┌──────────┐  ┌───────────┐  ┌────────────┐        │
          │         │btn_positive│  │ 클릭 실패  │  │ 10초 경과  │        │
          │         │ 클릭 성공 │  └─────┬─────┘  └─────┬──────┘        │
          │         └────┬─────┘        │              │               │
          │              │              ▼              ▼               │
          │              ▼        ┌──────────────┐ ┌──────────────┐    │
          │    ┌─────────────────┐│ERROR_UNKNOWN │ │ERROR_TIMEOUT │    │
          │    │ CALL_ACCEPTED   ││(알 수 없는   │ │  (타임아웃)   │    │
          │    │  (수락 완료)     ││    오류)     │ └──────┬───────┘    │
          │    └────────┬────────┘└──────┬───────┘        │            │
          │             │                │                │            │
          │             │                └────────────────┼────────────┘
          │             │                                 │
          │             │ 자동 리셋                        │ 재시도
          │             │                                 │
          │             └─────────────────────────────────┘
          │
          │ engine.stop()
          │
          ▼
    ┌─────────┐
    │  IDLE   │
    │ (대기)  │
    └─────────┘
```

---

## 4. 이벤트 시퀀스 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          이벤트 시퀀스 다이어그램                            │
└─────────────────────────────────────────────────────────────────────────────┘

 User    Floating   Engine   Accessibility   Handler   Logger   KakaoT
  │       Service     │        Service         │         │       Driver
  │          │        │           │            │         │         │
  │  ▶ 클릭  │        │           │            │         │         │
  │─────────▶│        │           │            │         │         │
  │          │        │           │            │         │         │
  │          │ start()│           │            │         │         │
  │          │───────▶│           │            │         │         │
  │          │        │           │            │         │         │
  │          │        │ WAITING_FOR_CALL       │         │         │
  │          │        │──────────────────────────────────▶│         │
  │          │        │           │            │         │ logState│
  │          │        │           │            │         │         │
  │          │        │           │            │         │         │ 콜 화면
  │          │        │           │            │         │         │ 표시
  │          │        │           │◀───────────────────────────────│
  │          │        │           │ Accessibility                  │
  │          │        │           │ Event                          │
  │          │        │           │            │         │         │
  │          │        │processNode│            │         │         │
  │          │        │◀──────────│            │         │         │
  │          │        │           │            │         │         │
  │          │        │      handle()          │         │         │
  │          │        │───────────────────────▶│         │         │
  │          │        │           │            │         │         │
  │          │        │           │            │ findNode │         │
  │          │        │           │            │─────────────────▶ │
  │          │        │           │            │         │         │
  │          │        │           │            │ 버튼 노드│         │
  │          │        │           │            │◀─────────────────│
  │          │        │           │            │         │         │
  │          │        │           │            │ click() │         │
  │          │        │           │            │─────────────────▶ │
  │          │        │           │            │         │         │
  │          │        │           │            │ 성공     │         │
  │          │        │           │            │◀─────────────────│
  │          │        │           │            │         │         │
  │          │        │ Transition│            │         │         │
  │          │        │◀──────────────────────│         │         │
  │          │        │           │            │         │         │
  │          │        │ WAITING_FOR_CONFIRM    │         │         │
  │          │        │──────────────────────────────────▶│         │
  │          │        │           │            │         │ logState│
  │          │        │           │            │         │         │
  │          │        │           │            │         │         │ 확인
  │          │        │           │            │         │         │ 다이얼로그
  │          │        │           │◀───────────────────────────────│
  │          │        │           │            │         │         │
  │          │        │ ... (반복)│            │         │         │
  │          │        │           │            │         │         │
  │          │        │ CALL_ACCEPTED          │         │         │
  │          │        │──────────────────────────────────▶│         │
  │          │        │           │            │         │logResult│
  │          │        │           │            │         │         │
```

---

## 5. 컴포넌트별 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          컴포넌트별 데이터 흐름                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              입력 (Input)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  KakaoT Driver App                                                          │
│       │                                                                      │
│       │ UI 변경 이벤트                                                       │
│       ▼                                                                      │
│  AccessibilityEvent                                                          │
│  - eventType: TYPE_WINDOW_CONTENT_CHANGED                                   │
│  - packageName: com.kakao.taxi.driver                                       │
│       │                                                                      │
│       ▼                                                                      │
│  AccessibilityNodeInfo (rootInActiveWindow)                                 │
│  - 현재 화면의 모든 UI 요소 트리                                             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              처리 (Process)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  CallAcceptAccessibilityService                                             │
│       │                                                                      │
│       │ engine.processNode(rootNode)                                        │
│       ▼                                                                      │
│  CallAcceptEngineImpl                                                       │
│       │                                                                      │
│       │ handlerMap[currentState].handle(node, context)                      │
│       ▼                                                                      │
│  StateHandler (WaitingForCallHandler / WaitingForConfirmHandler)            │
│       │                                                                      │
│       │ findNode() → performAction(ACTION_CLICK)                            │
│       ▼                                                                      │
│  StateResult (Transition / Error / NoChange)                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              출력 (Output)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. 상태 변경                                                                │
│     _currentState.value = newState                                          │
│           │                                                                  │
│           ├──▶ StateLoggingObserver → RemoteLogger → HTTP POST             │
│           │                                                                  │
│           └──▶ CallAcceptViewModel → LiveData → UI 업데이트                 │
│                                                                              │
│  2. 버튼 클릭                                                                │
│     AccessibilityNodeInfo.performAction(ACTION_CLICK)                       │
│           │                                                                  │
│           └──▶ KakaoT Driver 앱에 클릭 이벤트 전달                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 타이밍 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             타이밍 다이어그램                                │
└─────────────────────────────────────────────────────────────────────────────┘

시간 ──────────────────────────────────────────────────────────────────────▶

     0ms        100ms       500ms       1000ms      1500ms      2000ms
      │          │           │           │           │           │
      │          │           │           │           │           │
  ────┼──────────┼───────────┼───────────┼───────────┼───────────┼────
      │          │           │           │           │           │
  Engine        콜 화면     버튼 발견    클릭 시도    확인 화면    버튼 발견
  Start()       감지        및 클릭     완료        감지         및 클릭
      │          │           │           │           │           │
      │          │           │           │           │           │
  STATE:       STATE:      STATE:      STATE:      STATE:      STATE:
  WAITING_     WAITING_    WAITING_    WAITING_    WAITING_    CALL_
  FOR_CALL     FOR_CALL    FOR_CALL    FOR_CONFIRM FOR_CONFIRM ACCEPTED
      │          │           │           │           │           │
      │          │           │           │           │           │
      │◀─── 버튼 검색 ────▶│◀── 클릭 ──▶│◀─ 버튼 검색 ─▶│◀─ 클릭 ─▶│
      │     ~100ms          │   ~50ms    │   ~100ms     │  ~50ms   │
      │                     │            │              │          │
      │                     │            │              │          │
      │◀──────────────────── 전체 소요 시간: ~1.5~2초 ─────────────▶│


  ※ 타임아웃 체크 (10초)
  ────────────────────────────────────────────────────────────────────▶
  0초                                                              10초
   │                                                                │
   │  상태 변경 없이 10초 경과 시                                     │
   │  → ERROR_TIMEOUT 상태로 전환                                    │
   │                                                                │
```

---

## 7. 에러 처리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            에러 처리 흐름                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  정상 흐름                              에러 발생 시
  ────────                              ──────────

  WAITING_FOR_CALL                      WAITING_FOR_CALL
       │                                     │
       │ 버튼 발견                            │ 버튼 없음 (10초 경과)
       ▼                                     ▼
  버튼 클릭 시도                         ERROR_TIMEOUT
       │                                     │
   ┌───┴───┐                                 │
   │       │                                 │
 성공    실패                                 │
   │       │                                 │
   ▼       ▼                                 │
WAITING_  ERROR_                             │
FOR_      UNKNOWN                            │
CONFIRM      │                               │
   │         │                               │
   │         └───────────────┬───────────────┘
   │                         │
   │                         ▼
   │              ┌─────────────────────┐
   │              │ StateLoggingObserver│
   │              │ 에러 로깅            │
   │              └──────────┬──────────┘
   │                         │
   │                         ▼
   │              ┌─────────────────────┐
   │              │ RemoteLogger        │
   │              │ logCallResult(      │
   │              │   success=false,    │
   │              │   error="..."       │
   │              │ )                   │
   │              └──────────┬──────────┘
   │                         │
   │                         ▼
   │              ┌─────────────────────┐
   │              │ 재시도 또는         │
   │              │ WAITING_FOR_CALL    │
   │              │ 로 복귀             │
   │              └─────────────────────┘
   │
   ▼
CALL_ACCEPTED
```
